[2025-06-04 08:11:59,034][INFO][1796][config.py:81] - --- (Start) Gold AI v5.4.7 ---
[2025-06-04 08:11:59,034][INFO][1796][config.py:82] - --- กำลังโหลดไลบรารีและตรวจสอบ Dependencies ---
[2025-06-04 08:11:59,034][INFO][1796][config.py:92] -    (Info) Using Pandas version: 2.2.2
[2025-06-04 08:11:59,035][INFO][1796][config.py:92] -    (Info) Using NumPy version: 2.0.2
[2025-06-04 08:11:59,035][INFO][1796][config.py:92] -    (Info) Using Scikit-learn version: 1.6.1
[2025-06-04 08:11:59,044][INFO][1796][config.py:92] -    (Info) Using TA version: N/A
INFO:NiceGold:   (Info) Using TA version: N/A
[2025-06-04 08:11:59,074][INFO][1796][config.py:92] -    (Info) Using Optuna version: 4.3.0
INFO:NiceGold:   (Info) Using Optuna version: 4.3.0
INFO:root:   (Info) ตรวจสอบเวอร์ชัน CatBoost: 1.2.8
INFO:root:   (Info) ตรวจสอบจำนวน GPU สำหรับ CatBoost: 1
[2025-06-04 08:11:59,191][INFO][1796][config.py:92] -    (Info) Using psutil version: 5.9.5
INFO:NiceGold:   (Info) Using psutil version: 5.9.5
[2025-06-04 08:11:59,663][INFO][1796][config.py:92] -    (Info) Using SHAP version: 0.47.2
INFO:NiceGold:   (Info) Using SHAP version: 0.47.2
INFO:root:(Info) รันบน Google Colab – กำลัง mount Google Drive...
WARNING:root:(Warning) ล้มเหลวในการ mount Drive: 'NoneType' object has no attribute 'kernel' -- ดำเนินการต่อโดยใช้ Local Path แทน
INFO:root:   (Checking) กำลังตรวจสอบความพร้อมใช้งาน GPU...
INFO:root:   (Success) พบ GPU: Tesla T4
INFO:root:   (Success) เริ่มต้น pynvml สำหรับการตรวจสอบ GPU สำเร็จ.
INFO:root:   สถานะการเร่งความเร็วด้วย GPU: True
INFO:root:Loading Global Configuration Settings...
INFO:root:Multi-Fund Mode: True
INFO:root:Fund Profiles: ['SAFE', 'NORMAL', 'SPIKE', 'AGGRESSIVE', 'MIRROR']
INFO:root:IB Commission per Lot: $7.00
INFO:root:Part 1: Setup & Configuration Complete.
INFO:root:Loading Core Parameters & Strategy Settings...
INFO:root:Kill Switch Enabled: True (DD > 25%, Losses > 7)
INFO:root:Max Drawdown Threshold (Block New Orders): 30%
INFO:root:Spike Guard Enabled: True
INFO:root:Recovery Mode Enabled: Losses >= 4, Lot Multiplier: 0.5
INFO:root:Re-Entry Enabled: True (Cooldown: 1 bars, Threshold: 0.5)
INFO:root:   *** (Config Info) Forced Entry is ENABLED: True ***
INFO:root:Default Risk Per Trade: 1.00%
INFO:root:Lot Size Limits: Min=0.01, Max=5.0
INFO:root:Part 2: Core Parameters & Strategy Settings Loaded.
INFO:root:Part 3: Helper Functions Loaded (v4.8.8 Patch 26.10 Applied).
INFO:root:Part 4: Data Loading & Initial Preparation Functions Loaded.
INFO:root:Part 5: Feature Engineering & Indicator Calculation Functions Loaded.
INFO:root:Loading Machine Learning Configuration & Helpers...
INFO:root:USE_META_CLASSIFIER (L1 Filter): True
INFO:root:USE_META_META_CLASSIFIER (L2 Filter): False
INFO:root:Default L1 Probability Threshold: 0.5
INFO:root:Default Re-entry Probability Threshold: 0.5
INFO:root:Default L2 Probability Threshold: 0.5
INFO:root:Optuna Hyperparameter Tuning Enabled: True
INFO:root:  Optuna Trials: 50
INFO:root:  Optuna CV Splits: 5
INFO:root:  Optuna Metric: AUC (maximize)
INFO:root:Auto Threshold Tuning Enabled: False
INFO:root:Part 6: Machine Learning Configuration & Helpers Loaded (v4.8.8 Patch 9 Applied).
INFO:root:Part 7: Model Training Function Loaded (v5.4.7 Applied).
INFO:root:Part 8: Backtesting Engine Functions Loaded (v5.4.7 Applied).
INFO:root:Part 9: Walk-Forward Orchestration & Analysis Functions Loaded.
INFO:root:   (Setup) ตรวจสอบโฟลเดอร์ผลลัพธ์: ./output_default
[2025-06-04 08:12:02,089][INFO][1796][main.py:1519] - Loading Part 11: MT5 Connector (Placeholder)...
INFO:NiceGold:Loading Part 11: MT5 Connector (Placeholder)...
INFO:root:Part 11: MT5 Connector (Placeholder) Loaded.
INFO:root:Reached End of Part 12 (End of Script Marker).
INFO:root:
(Starting) กำลังเริ่มฟังก์ชัน Main (Mode: FULL_PIPELINE)...
INFO:root:   (Info) Output directory already set: ./output_default
INFO:root:   (Setup) กำลังตรวจสอบ/สร้าง Output Directory: ./output_default
INFO:root:      -> Directory exists or was created.
INFO:root:      -> การเขียนไฟล์ทดสอบสำเร็จ.
INFO:root:   Run Mode Selected: FULL_PIPELINE
INFO:root:
(Starting) กำลังเริ่ม FULL PIPELINE...
INFO:root:(Info) พบ trade log แล้ว ข้าม PREPARE_TRAIN_DATA
INFO:root:(Info) พบโมเดลแล้ว
INFO:root:
(Starting) กำลังเริ่มฟังก์ชัน Main (Mode: FULL_RUN)...
INFO:root:   (Info) Output directory already set: ./output_default
INFO:root:   (Setup) กำลังตรวจสอบ/สร้าง Output Directory: ./output_default
INFO:root:      -> Directory exists or was created.
INFO:root:      -> การเขียนไฟล์ทดสอบสำเร็จ.
INFO:root:   Run Mode Selected: FULL_RUN
INFO:root:
--- (Loading) กำลังโหลดและเตรียมข้อมูลสำหรับ FULL_RUN ---
INFO:root:(Loading) กำลังโหลดข้อมูล M15 จาก: /content/drive/MyDrive/Phiradon168/XAUUSD_M15.csv
INFO:root:   ไฟล์ดิบ M15: 118172 แถว
INFO:root:   [Data Quality] ตรวจสอบ % NaN ในคอลัมน์ราคา...
INFO:root:      NaN Percentage:
Open     0.0
High     0.0
Low      0.0
Close    0.0
dtype: float64
INFO:root:   [Data Quality] ตรวจสอบ Duplicates (Date & Timestamp)...
INFO:root:   [Data Quality] ตรวจสอบ Price Jumps (Threshold > 10.0%)...
INFO:root:(Success) โหลดและตรวจสอบข้อมูล M15 สำเร็จ: 118172 แถว
INFO:root:(Loading) กำลังโหลดข้อมูล M1 จาก: /content/drive/MyDrive/Phiradon168/XAUUSD_M1.csv
INFO:root:   ไฟล์ดิบ M1: 321073 แถว
INFO:root:   [Data Quality] ตรวจสอบ % NaN ในคอลัมน์ราคา...
INFO:root:      NaN Percentage:
Open     0.0
High     0.0
Low      0.0
Close    0.0
dtype: float64
INFO:root:   [Data Quality] ตรวจสอบ Duplicates (Date & Timestamp)...
INFO:root:   [Data Quality] ตรวจสอบ Price Jumps (Threshold > 10.0%)...
INFO:root:(Success) โหลดและตรวจสอบข้อมูล M1 สำเร็จ: 321073 แถว
INFO:root:(Processing) กำลังเตรียม Datetime Index (M15)...
INFO:root:   [Preview] First 5 Date + Timestamp format examples:
INFO:root:
25630501 00:00:00
25630501 00:15:00
25630501 00:30:00
25630501 00:45:00
25630501 01:00:00
INFO:root:      [Converter] กำลังตรวจสอบและแปลงปี พ.ศ. เป็น ค.ศ. (ถ้าจำเป็น)...
INFO:root:      [Converter] พบปี พ.ศ. ใน 118172 แถว, กำลังแปลงเป็น ค.ศ....
INFO:root:      [Converter] (Success) แปลงปี พ.ศ. → ค.ศ. แบบ vectorized สำเร็จ.
INFO:root:(Success) เตรียม Datetime index (M15) สำเร็จ. Shape: (118172, 8)
INFO:root:(Processing) กำลังเตรียม Datetime Index (M1)...
INFO:root:   [Preview] First 5 Date + Timestamp format examples:
INFO:root:
25660416 22:00:00
25660416 22:01:00
25660416 22:02:00
25660416 22:03:00
25660416 22:04:00
INFO:root:      [Converter] กำลังตรวจสอบและแปลงปี พ.ศ. เป็น ค.ศ. (ถ้าจำเป็น)...
INFO:root:      [Converter] พบปี พ.ศ. ใน 321073 แถว, กำลังแปลงเป็น ค.ศ....
INFO:root:      [Converter] (Success) แปลงปี พ.ศ. → ค.ศ. แบบ vectorized สำเร็จ.
INFO:root:(Success) เตรียม Datetime index (M1) สำเร็จ. Shape: (321073, 8)
INFO:root:(Processing) กำลังคำนวณ M15 Trend Zone...
INFO:root:   การกระจาย M15 Trend Zone:
Trend_Zone
NEUTRAL    0.480
UP         0.292
DOWN       0.228
INFO:root:[QA] Start M1 Feature Engineering
INFO:root:(Processing) กำลังสร้าง Features M1 (v4.9.0)...
INFO:root:   (Processing) Tagging price structure patterns...
INFO:root:      Pattern Label Distribution:
Pattern_Label
Breakout       0.535
Reversal       0.171
Choppy         0.141
InsideBar      0.081
Normal         0.071
StrongTrend    0.002
INFO:root:      Creating 'session' column...
[2025-06-04 08:12:16,758][WARNING][1796][sessions.py:35] - get_session_tag: Global SESSION_TIMES_UTC not found, using default.
WARNING:NiceGold:get_session_tag: Global SESSION_TIMES_UTC not found, using default.
INFO:root:         Session distribution:
session
Asia           0.306
London         0.218
NY             0.214
London/NY      0.131
Other          0.086
Asia/London    0.044
INFO:root:(Success) สร้าง Features M1 (v4.9.0) เสร็จสิ้น.
WARNING:root:[QA WARNING] NaN/Inf detected in engineered features
INFO:root:[QA] M1 Feature Engineering Completed
INFO:root:(Processing) กำลังกำหนด Features M1 สำหรับ Drift และแปลงประเภท (v4.9.0)...
INFO:root:   กำหนด 28 Features M1 สำหรับ Drift: ['ADX', 'ATR_14', 'ATR_14_Rolling_Avg', 'ATR_14_Shifted', 'Candle_Body', 'Candle_Range', 'Candle_Ratio', 'Candle_Speed', 'Candle_Speed_lag1', 'Candle_Speed_lag3', 'Candle_Speed_lag5', 'Gain', 'Gain_Z', 'Gain_Z_lag1', 'Gain_Z_lag3', 'Gain_Z_lag5', 'MACD_hist', 'MACD_hist_smooth', 'MACD_line', 'MACD_signal', 'Pattern_Label', 'RSI', 'Volatility_Index', 'Wick_Length', 'Wick_Ratio', 'cluster', 'session', 'spike_score']
INFO:root:(Success) กำหนด Features M1 และแปลงประเภท (v4.9.0) เสร็จสิ้น.
INFO:root:(Processing) กำลังรวม M15 Trend Zone...
INFO:root:(Processing) กำลังคำนวณ M1 Entry Signals...
INFO:root:(Processing) กำลังกำหนดคอลัมน์ Simulation ที่จำเป็น...
INFO:root:   (Feature Load) Attempting to load features for 'main' from: ./output_default/features_main.json
INFO:root:      (Success) Loaded 37 features for model 'main' from 'features_main.json'.
INFO:root:(Processing) กำลัง Drop NaN ครั้งสุดท้าย...
INFO:root:   ขนาดข้อมูล M1 สุดท้าย: (321073, 45)
INFO:root:   [RAM Opt] กำลังแปลง Final M1 Data เป็น float32...
INFO:root:   (Success) แปลง 33 Final M1 Data columns เป็น float32 (เท่าที่ทำได้) สำเร็จ.
INFO:root:   (Success) Final M1 Data ผ่านการตรวจสอบ NaN.
INFO:root:[Patch] สร้าง features_main.json จาก M1 Data สำเร็จ (37 features).
INFO:root:
--- (FULL_RUN) ตรวจสอบ/Train Models ที่ขาดหาย ---
INFO:root:
--- (Auto-Train Check) Ensuring Model Files Exist ---
WARNING:root:Missing model file for 'spike' (meta_classifier_spike.pkl).
WARNING:root:Missing model file for 'cluster' (meta_classifier_cluster.pkl).
WARNING:root:   Triggering Auto-Training for Missing Models: ['spike', 'cluster']
INFO:root:      (safe_load) Attempting to load: trade_log_v32_walkforward.csv.gz
INFO:root:
(Training - v5.4.7) เริ่มต้นการ Train Meta Classifier (Purpose: SPIKE)...
INFO:root:   Model Type: catboost
INFO:root:   Sample Size Limit: 60000
INFO:root:   Features to Drop Before Final Train: None
INFO:root:   Dynamic Feature Selection: เปิดใช้งาน
INFO:root:     Method: SHAP
INFO:root:     SHAP Threshold: 0.0100
INFO:root:     Permutation Threshold: 0.0010
INFO:root:   Optuna Tuning: ปิดใช้งาน
INFO:root:   Drift Observer Provided: No
INFO:root:   Early Stopping Rounds: 200
INFO:root:   GPU Acceleration Available: False. Setting CatBoost task_type to: 'CPU' (for applicable steps).
INFO:root:   ใช้ Trade Log ที่ Filter แล้ว (Override) จำนวน 382 แถว สำหรับ Model Purpose: SPIKE
INFO:root:   กำลังประมวลผล Trade Log สำหรับ Training...
INFO:root:   Target (is_tp from Log) Distribution:
is_tp
0    0.937
1    0.063
INFO:root:   ประมวลผล Trade Log สำเร็จ (382 trades).
INFO:root:   กำลังโหลด M1 Data: ./output_default/final_data_m1_v32_walkforward.csv.gz
INFO:root:      (safe_load) Attempting to load: final_data_m1_v32_walkforward.csv.gz
INFO:root:   โหลดและเตรียม M1 สำเร็จ (321073 แถว). จำนวน Features เริ่มต้น: 46
INFO:root:   กำลังเตรียมข้อมูลสำหรับ Meta Model Training (Purpose: SPIKE)...
INFO:root:   กำลังรวม Trade Log กับ M1 Features (merge_asof)...
INFO:root:[Patch] เริ่ม Merge Trade Log กับ M1 Features (merge_asof)
INFO:root:   Merge completed. Shape after merge: (382, 90)
INFO:root:[Patch] Available Features หลัง Merge: 36 รายการ
INFO:root:[Patch] Missing Features หลัง Merge: 1 รายการ: ['Signal_Score']
INFO:root:   Features เริ่มต้นสำหรับการเลือก (36): ['ADX', 'ATR_14', 'ATR_14_Rolling_Avg', 'ATR_14_Shifted', 'Candle_Body', 'Candle_Range', 'Candle_Ratio', 'Candle_Speed', 'Candle_Speed_lag1', 'Candle_Speed_lag3', 'Candle_Speed_lag5', 'Close', 'Date', 'Entry_Long', 'Entry_Short', 'Gain', 'Gain_Z', 'Gain_Z_lag1', 'Gain_Z_lag3', 'Gain_Z_lag5', 'High', 'Low', 'Lower_Wick', 'MACD_hist', 'MACD_hist_smooth', 'MACD_line', 'MACD_signal', 'Open', 'RSI', 'Upper_Wick', 'Volatility_Index', 'Volume', 'Wick_Length', 'Wick_Ratio', 'cluster', 'spike_score']
INFO:root:   [NaN Check] ก่อน Drop NaN ใน Merged Data (Features/Target): 382 แถว
INFO:root:   (Success) การรวมข้อมูลเสร็จสมบูรณ์ (382 samples before sampling).
INFO:root:   (Info) Sample size (60000) >= data size (382). Using all data.
INFO:root:
   --- [Phase 2/B] กำลังดำเนินการ Dynamic Feature Selection ---
INFO:root:      (Info) ไม่พบ Categorical Feature 'Pattern_Label' สำหรับ Prelim Model.
INFO:root:      [NaN Check] ตรวจสอบ NaN/Inf ในข้อมูล Feature Selection (X_select)...
INFO:root:         เติม NaN/Inf ใน X_select สำเร็จ.
INFO:root:      กำลัง Train Preliminary Model (สำหรับ Feature Importance)...
INFO:root:         (ใช้ Default Prelim Params)
INFO:root:         (Prelim Task Type: CPU)
INFO:root:[Before Prelim Fit] GPU Util: 0% | Mem: 0% (267MB / 15360MB) | RAM: 17.2% (1910MB / 12977MB)
INFO:root:[After Prelim Fit] GPU Util: 0% | Mem: 0% (267MB / 15360MB) | RAM: 16.9% (1869MB / 12977MB)
INFO:root:      (Success) Train Preliminary Model สำเร็จ.
INFO:root:      กำลังคำนวณ SHAP Importance...
INFO:root:   [SHAP Select] กำลังเลือก Features ที่มี Normalized SHAP >= 0.0100...
INFO:root:      (Success) เลือก Features ได้ 30 ตัวจาก SHAP.
INFO:root:         Features ที่ถูกตัดออก 6 ตัว: ['ATR_14', 'ATR_14_Shifted', 'Candle_Ratio', 'Gain_Z_lag3', 'Wick_Length', 'cluster']
INFO:root:         Features ที่เลือก (เรียงตามค่า SHAP):
INFO:root:
           Feature  Normalized_SHAP
               RSI          0.16355
  MACD_hist_smooth          0.06513
              Date          0.05868
         MACD_hist          0.05733
               Low          0.05496
              Open          0.04508
               ADX          0.03896
              High          0.03818
        Entry_Long          0.03790
        Upper_Wick          0.03067
             Close          0.03034
              Gain          0.02296
         MACD_line          0.02294
            Gain_Z          0.02223
 Candle_Speed_lag1          0.02200
       Gain_Z_lag1          0.02180
 Candle_Speed_lag5          0.01901
  Volatility_Index          0.01841
       MACD_signal          0.01837
      Candle_Speed          0.01811
            Volume          0.01748
       spike_score          0.01739
        Lower_Wick          0.01718
ATR_14_Rolling_Avg          0.01690
       Entry_Short          0.01647
      Candle_Range          0.01402
       Candle_Body          0.01401
        Wick_Ratio          0.01223
 Candle_Speed_lag3          0.01146
       Gain_Z_lag5          0.01087
INFO:root:      Features ที่เลือกโดย SHAP (30): ['ADX', 'ATR_14_Rolling_Avg', 'Candle_Body', 'Candle_Range', 'Candle_Speed', 'Candle_Speed_lag1', 'Candle_Speed_lag3', 'Candle_Speed_lag5', 'Close', 'Date', 'Entry_Long', 'Entry_Short', 'Gain', 'Gain_Z', 'Gain_Z_lag1', 'Gain_Z_lag5', 'High', 'Low', 'Lower_Wick', 'MACD_hist', 'MACD_hist_smooth', 'MACD_line', 'MACD_signal', 'Open', 'RSI', 'Upper_Wick', 'Volatility_Index', 'Volume', 'Wick_Ratio', 'spike_score']
INFO:root:      พิจารณาเพิ่ม Lag Features ที่สำคัญ...
INFO:root:         Lag Features ที่มีให้พิจารณา: ['Gain_Z_lag1', 'Gain_Z_lag3', 'Gain_Z_lag5', 'Candle_Speed_lag1', 'Candle_Speed_lag3', 'Candle_Speed_lag5']
WARNING:root:         (Warning) ไม่สามารถประเมินความสำคัญ Lag Features: 'numpy.ndarray' object has no attribute 'values'
INFO:root:   --- [Phase 2/B] Final Selected Features (30): ['ADX', 'ATR_14_Rolling_Avg', 'Candle_Body', 'Candle_Range', 'Candle_Speed', 'Candle_Speed_lag1', 'Candle_Speed_lag3', 'Candle_Speed_lag5', 'Close', 'Date', 'Entry_Long', 'Entry_Short', 'Gain', 'Gain_Z', 'Gain_Z_lag1', 'Gain_Z_lag5', 'High', 'Low', 'Lower_Wick', 'MACD_hist', 'MACD_hist_smooth', 'MACD_line', 'MACD_signal', 'Open', 'RSI', 'Upper_Wick', 'Volatility_Index', 'Volume', 'Wick_Ratio', 'spike_score'] ---
INFO:root:
   กำลังเตรียมข้อมูล Training สุดท้ายด้วย Features ที่เลือก (30 ตัว)...
INFO:root:      [NaN Check] ตรวจสอบ NaN/Inf ในข้อมูล Final Training (X)...
INFO:root:         เติม NaN/Inf ใน X (Final) สำเร็จ.
INFO:root:      [RAM Opt] Converting Final Training Features (X) to float32 (Before Split)...
INFO:root:      (Success) แปลง 27 Final Training Features เป็น float32 (เท่าที่ทำได้) สำเร็จ.
INFO:root:
   --- [Phase 3/A] ข้าม Hyperparameter Optimization (Optuna ปิดใช้งาน หรือ Model ไม่ใช่ CatBoost) ---
INFO:root:
   --- Training Final CatBoost Model (Purpose: SPIKE) ---
INFO:root:      (Info) ไม่พบ 'Pattern_Label' ใน Features ที่เลือกสุดท้าย.
INFO:root:      Splitting data into Train/Validation sets (80/20 stratified)...
INFO:root:      Train Size (Final): 305, Validation Size (Final): 77
INFO:root:      Validation Target Distribution (Final):
is_tp
0    0.935
1    0.065
INFO:root:      [RAM Opt] Converting Train/Validation sets to float32 (After Split)...
INFO:root:      กำลังกำหนด Final Model Parameters...
INFO:root:         Using Fixed Params (v4.7.1)...
INFO:root:         Final Params: {'iterations': 3000, 'learning_rate': 0.01, 'depth': 4, 'l2_leaf_reg': 30, 'eval_metric': 'AUC', 'auto_class_weights': 'Balanced', 'early_stopping_rounds': 200, 'random_seed': 42, 'verbose': 100, 'loss_function': 'Logloss', 'task_type': 'CPU'}
INFO:root:      Fitting Final CatBoost model (Purpose: SPIKE)...
INFO:root:[Before Final Fit] GPU Util: 0% | Mem: 0% (267MB / 15360MB) | RAM: 16.9% (1876MB / 12977MB)
0:	test: 0.6305556	best: 0.6305556 (0)	total: 2.66ms	remaining: 7.98s
100:	test: 0.8263889	best: 0.8402778 (2)	total: 164ms	remaining: 4.7s
200:	test: 0.8486111	best: 0.8569444 (169)	total: 333ms	remaining: 4.64s
300:	test: 0.8347222	best: 0.8569444 (169)	total: 495ms	remaining: 4.44s
Stopped by overfitting detector  (200 iterations wait)

bestTest = 0.8569444444
bestIteration = 169

Shrink model to first 170 iterations.
INFO:root:[After Final Fit] GPU Util: 0% | Mem: 0% (267MB / 15360MB) | RAM: 17.0% (1884MB / 12977MB)
INFO:root:      (Success) Final CatBoost training (Purpose: SPIKE) finished in 1.48 seconds.
INFO:root:
      --- Model Quality Check (Final CatBoost Model) ---
INFO:root:   [Check] Checking for Overfitting (AUC)...
INFO:root:      Val AUC:   0.8569
INFO:root:   [Check] Checking for Overfitting (LogLoss)...
INFO:root:      Val LogLoss:   0.4538
INFO:root:      Validation Metrics (Final Model - Purpose: SPIKE):
INFO:root:         Accuracy:  0.7792
INFO:root:         AUC:       0.8569
INFO:root:         LogLoss:   0.4538
INFO:root:         Classification Report:
              precision    recall  f1-score   support

      Not TP       0.97      0.79      0.87        72
          TP       0.17      0.60      0.26         5

    accuracy                           0.78        77
   macro avg       0.57      0.70      0.57        77
weighted avg       0.91      0.78      0.83        77

INFO:root:
      --- SHAP Analysis (Final Model - Validation Set - Purpose: SPIKE) ---
INFO:root:
(Analyzing) SHAP analysis (CatBoostClassifier - Sample Size: 77) -  Validation Set...
INFO:root:      Calculating SHAP values (CatBoost)...
INFO:root:      Creating SHAP Summary Plot (bar type)...
INFO:root:      (Success) Saved SHAP Plot (Bar): shap_summary_CatBoostClassifier_bar_validation_set.png
INFO:root:      Creating SHAP Summary Plot (beeswarm/dot type)...
INFO:root:      (Success) Saved SHAP Plot (Beeswarm): shap_summary_CatBoostClassifier_beeswarm_validation_set.png
INFO:root:
         --- Feature Noise Check (SHAP - Final Model - Validation Set) ---
INFO:root:            Recalculating SHAP values for Noise Check (Validation Set)...
INFO:root:   [Check] Checking for Feature Noise (SHAP)...
INFO:root:[Patch] SHAP Noise features detected: ['Candle_Body', 'Candle_Range', 'Candle_Speed_lag3', 'Candle_Speed_lag5', 'Gain_Z_lag5', 'Lower_Wick', 'MACD_line', 'Upper_Wick', 'Wick_Ratio', 'spike_score']
INFO:root:
   --- Saving Final Model (Purpose: SPIKE) ---
INFO:root:      (Success) Saved Final CATBOOST (Purpose: SPIKE): ./output_default/meta_classifier_spike.pkl
INFO:root:   Saving final selected features (30) for 'spike' to: ./output_default/features_spike.json
INFO:root:   (Success) Saved final features list for 'spike'.
INFO:root:(Finished - v5.4.7) Meta Classifier Training (Purpose: SPIKE) complete in 14.97 seconds.
INFO:root:
(Training - v5.4.7) เริ่มต้นการ Train Meta Classifier (Purpose: CLUSTER)...
INFO:root:   Model Type: catboost
INFO:root:   Sample Size Limit: 60000
INFO:root:   Features to Drop Before Final Train: None
INFO:root:   Dynamic Feature Selection: เปิดใช้งาน
INFO:root:     Method: SHAP
INFO:root:     SHAP Threshold: 0.0100
INFO:root:     Permutation Threshold: 0.0010
INFO:root:   Optuna Tuning: ปิดใช้งาน
INFO:root:   Drift Observer Provided: No
INFO:root:   Early Stopping Rounds: 200
INFO:root:   GPU Acceleration Available: False. Setting CatBoost task_type to: 'CPU' (for applicable steps).
INFO:root:   ใช้ Trade Log ที่ Filter แล้ว (Override) จำนวน 382 แถว สำหรับ Model Purpose: CLUSTER
INFO:root:   กำลังประมวลผล Trade Log สำหรับ Training...
INFO:root:   Target (is_tp from Log) Distribution:
is_tp
0    0.937
1    0.063
INFO:root:   ประมวลผล Trade Log สำเร็จ (382 trades).
INFO:root:   กำลังโหลด M1 Data: ./output_default/final_data_m1_v32_walkforward.csv.gz
INFO:root:      (safe_load) Attempting to load: final_data_m1_v32_walkforward.csv.gz
INFO:root:   โหลดและเตรียม M1 สำเร็จ (321073 แถว). จำนวน Features เริ่มต้น: 46
INFO:root:   กำลังเตรียมข้อมูลสำหรับ Meta Model Training (Purpose: CLUSTER)...
INFO:root:   กำลังรวม Trade Log กับ M1 Features (merge_asof)...
INFO:root:[Patch] เริ่ม Merge Trade Log กับ M1 Features (merge_asof)
INFO:root:   Merge completed. Shape after merge: (382, 90)
INFO:root:[Patch] Available Features หลัง Merge: 36 รายการ
INFO:root:[Patch] Missing Features หลัง Merge: 1 รายการ: ['Signal_Score']
INFO:root:   Features เริ่มต้นสำหรับการเลือก (36): ['ADX', 'ATR_14', 'ATR_14_Rolling_Avg', 'ATR_14_Shifted', 'Candle_Body', 'Candle_Range', 'Candle_Ratio', 'Candle_Speed', 'Candle_Speed_lag1', 'Candle_Speed_lag3', 'Candle_Speed_lag5', 'Close', 'Date', 'Entry_Long', 'Entry_Short', 'Gain', 'Gain_Z', 'Gain_Z_lag1', 'Gain_Z_lag3', 'Gain_Z_lag5', 'High', 'Low', 'Lower_Wick', 'MACD_hist', 'MACD_hist_smooth', 'MACD_line', 'MACD_signal', 'Open', 'RSI', 'Upper_Wick', 'Volatility_Index', 'Volume', 'Wick_Length', 'Wick_Ratio', 'cluster', 'spike_score']
INFO:root:   [NaN Check] ก่อน Drop NaN ใน Merged Data (Features/Target): 382 แถว
INFO:root:   (Success) การรวมข้อมูลเสร็จสมบูรณ์ (382 samples before sampling).
INFO:root:   (Info) Sample size (60000) >= data size (382). Using all data.
INFO:root:
   --- [Phase 2/B] กำลังดำเนินการ Dynamic Feature Selection ---
INFO:root:      (Info) ไม่พบ Categorical Feature 'Pattern_Label' สำหรับ Prelim Model.
INFO:root:      [NaN Check] ตรวจสอบ NaN/Inf ในข้อมูล Feature Selection (X_select)...
INFO:root:         เติม NaN/Inf ใน X_select สำเร็จ.
INFO:root:      กำลัง Train Preliminary Model (สำหรับ Feature Importance)...
INFO:root:         (ใช้ Default Prelim Params)
INFO:root:         (Prelim Task Type: CPU)
INFO:root:[Before Prelim Fit] GPU Util: 0% | Mem: 0% (267MB / 15360MB) | RAM: 17.1% (1900MB / 12977MB)
INFO:root:[After Prelim Fit] GPU Util: 0% | Mem: 0% (267MB / 15360MB) | RAM: 17.1% (1900MB / 12977MB)
INFO:root:      (Success) Train Preliminary Model สำเร็จ.
INFO:root:      กำลังคำนวณ SHAP Importance...
INFO:root:   [SHAP Select] กำลังเลือก Features ที่มี Normalized SHAP >= 0.0100...
INFO:root:      (Success) เลือก Features ได้ 30 ตัวจาก SHAP.
INFO:root:         Features ที่ถูกตัดออก 6 ตัว: ['ATR_14', 'ATR_14_Shifted', 'Candle_Ratio', 'Gain_Z_lag3', 'Wick_Length', 'cluster']
INFO:root:         Features ที่เลือก (เรียงตามค่า SHAP):
INFO:root:
           Feature  Normalized_SHAP
               RSI          0.16355
  MACD_hist_smooth          0.06513
              Date          0.05868
         MACD_hist          0.05733
               Low          0.05496
              Open          0.04508
               ADX          0.03896
              High          0.03818
        Entry_Long          0.03790
        Upper_Wick          0.03067
             Close          0.03034
              Gain          0.02296
         MACD_line          0.02294
            Gain_Z          0.02223
 Candle_Speed_lag1          0.02200
       Gain_Z_lag1          0.02180
 Candle_Speed_lag5          0.01901
  Volatility_Index          0.01841
       MACD_signal          0.01837
      Candle_Speed          0.01811
            Volume          0.01748
       spike_score          0.01739
        Lower_Wick          0.01718
ATR_14_Rolling_Avg          0.01690
       Entry_Short          0.01647
      Candle_Range          0.01402
       Candle_Body          0.01401
        Wick_Ratio          0.01223
 Candle_Speed_lag3          0.01146
       Gain_Z_lag5          0.01087
INFO:root:      Features ที่เลือกโดย SHAP (30): ['ADX', 'ATR_14_Rolling_Avg', 'Candle_Body', 'Candle_Range', 'Candle_Speed', 'Candle_Speed_lag1', 'Candle_Speed_lag3', 'Candle_Speed_lag5', 'Close', 'Date', 'Entry_Long', 'Entry_Short', 'Gain', 'Gain_Z', 'Gain_Z_lag1', 'Gain_Z_lag5', 'High', 'Low', 'Lower_Wick', 'MACD_hist', 'MACD_hist_smooth', 'MACD_line', 'MACD_signal', 'Open', 'RSI', 'Upper_Wick', 'Volatility_Index', 'Volume', 'Wick_Ratio', 'spike_score']
INFO:root:      พิจารณาเพิ่ม Lag Features ที่สำคัญ...
INFO:root:         Lag Features ที่มีให้พิจารณา: ['Gain_Z_lag1', 'Gain_Z_lag3', 'Gain_Z_lag5', 'Candle_Speed_lag1', 'Candle_Speed_lag3', 'Candle_Speed_lag5']
WARNING:root:         (Warning) ไม่สามารถประเมินความสำคัญ Lag Features: 'numpy.ndarray' object has no attribute 'values'
INFO:root:   --- [Phase 2/B] Final Selected Features (30): ['ADX', 'ATR_14_Rolling_Avg', 'Candle_Body', 'Candle_Range', 'Candle_Speed', 'Candle_Speed_lag1', 'Candle_Speed_lag3', 'Candle_Speed_lag5', 'Close', 'Date', 'Entry_Long', 'Entry_Short', 'Gain', 'Gain_Z', 'Gain_Z_lag1', 'Gain_Z_lag5', 'High', 'Low', 'Lower_Wick', 'MACD_hist', 'MACD_hist_smooth', 'MACD_line', 'MACD_signal', 'Open', 'RSI', 'Upper_Wick', 'Volatility_Index', 'Volume', 'Wick_Ratio', 'spike_score'] ---
INFO:root:
   กำลังเตรียมข้อมูล Training สุดท้ายด้วย Features ที่เลือก (30 ตัว)...
INFO:root:      [NaN Check] ตรวจสอบ NaN/Inf ในข้อมูล Final Training (X)...
INFO:root:         เติม NaN/Inf ใน X (Final) สำเร็จ.
INFO:root:      [RAM Opt] Converting Final Training Features (X) to float32 (Before Split)...
INFO:root:      (Success) แปลง 27 Final Training Features เป็น float32 (เท่าที่ทำได้) สำเร็จ.
INFO:root:
   --- [Phase 3/A] ข้าม Hyperparameter Optimization (Optuna ปิดใช้งาน หรือ Model ไม่ใช่ CatBoost) ---
INFO:root:
   --- Training Final CatBoost Model (Purpose: CLUSTER) ---
INFO:root:      (Info) ไม่พบ 'Pattern_Label' ใน Features ที่เลือกสุดท้าย.
INFO:root:      Splitting data into Train/Validation sets (80/20 stratified)...
INFO:root:      Train Size (Final): 305, Validation Size (Final): 77
INFO:root:      Validation Target Distribution (Final):
is_tp
0    0.935
1    0.065
INFO:root:      [RAM Opt] Converting Train/Validation sets to float32 (After Split)...
INFO:root:      กำลังกำหนด Final Model Parameters...
INFO:root:         Using Fixed Params (v4.7.1)...
INFO:root:         Final Params: {'iterations': 3000, 'learning_rate': 0.01, 'depth': 4, 'l2_leaf_reg': 30, 'eval_metric': 'AUC', 'auto_class_weights': 'Balanced', 'early_stopping_rounds': 200, 'random_seed': 42, 'verbose': 100, 'loss_function': 'Logloss', 'task_type': 'CPU'}
INFO:root:      Fitting Final CatBoost model (Purpose: CLUSTER)...
INFO:root:[Before Final Fit] GPU Util: 0% | Mem: 0% (267MB / 15360MB) | RAM: 17.1% (1900MB / 12977MB)
0:	test: 0.6305556	best: 0.6305556 (0)	total: 2.34ms	remaining: 7.01s
100:	test: 0.8263889	best: 0.8402778 (2)	total: 175ms	remaining: 5.01s
200:	test: 0.8486111	best: 0.8569444 (169)	total: 359ms	remaining: 4.99s
300:	test: 0.8347222	best: 0.8569444 (169)	total: 526ms	remaining: 4.71s
Stopped by overfitting detector  (200 iterations wait)

bestTest = 0.8569444444
bestIteration = 169

Shrink model to first 170 iterations.
INFO:root:[After Final Fit] GPU Util: 0% | Mem: 0% (267MB / 15360MB) | RAM: 17.1% (1900MB / 12977MB)
INFO:root:      (Success) Final CatBoost training (Purpose: CLUSTER) finished in 0.86 seconds.
INFO:root:
      --- Model Quality Check (Final CatBoost Model) ---
INFO:root:   [Check] Checking for Overfitting (AUC)...
INFO:root:      Val AUC:   0.8569
INFO:root:   [Check] Checking for Overfitting (LogLoss)...
INFO:root:      Val LogLoss:   0.4538
INFO:root:      Validation Metrics (Final Model - Purpose: CLUSTER):
INFO:root:         Accuracy:  0.7792
INFO:root:         AUC:       0.8569
INFO:root:         LogLoss:   0.4538
INFO:root:         Classification Report:
              precision    recall  f1-score   support

      Not TP       0.97      0.79      0.87        72
          TP       0.17      0.60      0.26         5

    accuracy                           0.78        77
   macro avg       0.57      0.70      0.57        77
weighted avg       0.91      0.78      0.83        77

INFO:root:
      --- SHAP Analysis (Final Model - Validation Set - Purpose: CLUSTER) ---
INFO:root:
(Analyzing) SHAP analysis (CatBoostClassifier - Sample Size: 77) -  Validation Set...
INFO:root:      Calculating SHAP values (CatBoost)...
INFO:root:      Creating SHAP Summary Plot (bar type)...
INFO:root:      (Success) Saved SHAP Plot (Bar): shap_summary_CatBoostClassifier_bar_validation_set.png
INFO:root:      Creating SHAP Summary Plot (beeswarm/dot type)...
INFO:root:      (Success) Saved SHAP Plot (Beeswarm): shap_summary_CatBoostClassifier_beeswarm_validation_set.png
INFO:root:
         --- Feature Noise Check (SHAP - Final Model - Validation Set) ---
INFO:root:            Recalculating SHAP values for Noise Check (Validation Set)...
INFO:root:   [Check] Checking for Feature Noise (SHAP)...
INFO:root:[Patch] SHAP Noise features detected: ['Candle_Body', 'Candle_Range', 'Candle_Speed_lag3', 'Candle_Speed_lag5', 'Gain_Z_lag5', 'Lower_Wick', 'MACD_line', 'Upper_Wick', 'Wick_Ratio', 'spike_score']
INFO:root:
   --- Saving Final Model (Purpose: CLUSTER) ---
INFO:root:      (Success) Saved Final CATBOOST (Purpose: CLUSTER): ./output_default/meta_classifier_cluster.pkl
INFO:root:   Saving final selected features (30) for 'cluster' to: ./output_default/features_cluster.json
INFO:root:   (Success) Saved final features list for 'cluster'.
INFO:root:(Finished - v5.4.7) Meta Classifier Training (Purpose: CLUSTER) complete in 11.97 seconds.
INFO:root:--- (Auto-Train Check) Finished ---
INFO:root:
--- กำลังโหลด Models และ Features สำหรับ FULL_RUN (Model Switcher) ---
INFO:root:(Loading) พยายามโหลด Model 'main' จาก: ./output_default/meta_classifier.pkl
INFO:root:  (Success) โหลด Model 'main' (CatBoostClassifier) สำเร็จ.
INFO:root:(Loading) พยายามโหลด Features สำหรับ 'main'...
INFO:root:   (Feature Load) Attempting to load features for 'main' from: ./output_default/features_main.json
INFO:root:      (Success) Loaded 37 features for model 'main' from 'features_main.json'.
INFO:root:  (Success) โหลด Features (37) สำหรับ Model 'main' สำเร็จ.
INFO:root:(Loading) พยายามโหลด Model 'spike' จาก: ./output_default/meta_classifier_spike.pkl
INFO:root:  (Success) โหลด Model 'spike' (CatBoostClassifier) สำเร็จ.
INFO:root:(Loading) พยายามโหลด Features สำหรับ 'spike'...
INFO:root:   (Feature Load) Attempting to load features for 'spike' from: ./output_default/features_spike.json
INFO:root:      (Success) Loaded 30 features for model 'spike' from 'features_spike.json'.
INFO:root:  (Success) โหลด Features (30) สำหรับ Model 'spike' สำเร็จ.
INFO:root:(Loading) พยายามโหลด Model 'cluster' จาก: ./output_default/meta_classifier_cluster.pkl
INFO:root:  (Success) โหลด Model 'cluster' (CatBoostClassifier) สำเร็จ.
INFO:root:(Loading) พยายามโหลด Features สำหรับ 'cluster'...
INFO:root:   (Feature Load) Attempting to load features for 'cluster' from: ./output_default/features_cluster.json
INFO:root:      (Success) Loaded 30 features for model 'cluster' from 'features_cluster.json'.
INFO:root:  (Success) โหลด Features (30) สำหรับ Model 'cluster' สำเร็จ.
INFO:root:--- โหลด Models/Features เสร็จสิ้น: ['main', 'spike', 'cluster'] ---
INFO:root:   (DriftObserver) Initialized with 28 features to observe.
INFO:root:
(Info) ข้าม Auto Threshold Tuning (ใช้ Fixed Params สำหรับ Model).
INFO:root:
(Multi-Fund Mode) กำลังรันสำหรับ 5 Fund Profiles: ['SAFE', 'NORMAL', 'SPIKE', 'AGGRESSIVE', 'MIRROR']
INFO:root:
==================== STARTING FUND: SAFE (MM Mode: conservative) ====================
INFO:root:--- FINAL WALK-FORWARD RUN (Fund: SAFE, Suffix: _SAFE_fixed_params_switcher_on) ---
CRITICAL:root:   (CRITICAL) Function 'select_model_for_trade' not found. Cannot run with model switching.
INFO:root:
(Finished) FULL PIPELINE เสร็จสมบูรณ์.
[2025-06-04 08:12:48,798][INFO][1796][ProjectP.py:42] - [QA] Output present: ./output_default/features_main.json
INFO:NiceGold:[QA] Output present: ./output_default/features_main.json
[2025-06-04 08:12:48,798][INFO][1796][ProjectP.py:42] - [QA] Output present: ./output_default/trade_log_BUY.csv
INFO:NiceGold:[QA] Output present: ./output_default/trade_log_BUY.csv
[2025-06-04 08:12:48,798][INFO][1796][ProjectP.py:42] - [QA] Output present: ./output_default/trade_log_SELL.csv
INFO:NiceGold:[QA] Output present: ./output_default/trade_log_SELL.csv
[2025-06-04 08:12:48,799][INFO][1796][ProjectP.py:42] - [QA] Output present: ./output_default/trade_log_NORMAL.csv
INFO:NiceGold:[QA] Output present: ./output_default/trade_log_NORMAL.csv
INFO:root:GPU resources released
